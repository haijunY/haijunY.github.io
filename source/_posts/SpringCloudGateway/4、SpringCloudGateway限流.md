---
title: 4、SpringClouldGateway限流
date: 2020-06-03 15:00:00
categories: SpringCloudGateway
tags: [Gateway]

---

### 限流
在高并发的系统中，往往需要在系统中做限流，一方面为了防止大量的请求使服务器过载，导致服务器不可用，另一方面是为了防止网络攻击。
常见的限流方式，比如Hystrix使用线程池隔离，超过线程池的负载，走熔断逻辑。在一般应用服务器中，比如tomcat容器也是通过限制它的线程数来控制并发的；也有通过时间窗口的平均速度来控制流量。常见的限流维度比如通过ip来限流、通过uri来限流、通用用户访问频率来限流
一般限流都是在网关这一层做，比如Nginx、Openresty、kong、zuul、Spring Cloud Gateway等；也可以在应用层通过AOP来限流

#### 常见的限流算法
##### 计数器法
计算器法采用计数器实现，一般我们会限制一秒钟的能够通过的请求数，比如限流qps为100，算法的实现思路是从第一个请求进来开始计时，在接下去的1s内，每一个请求都把计数器+1，如果累加到100，那么后续的请求全部拒绝。等到1s结束后，把计数器恢复成0，重新开始计数。
##### 漏桶算法
漏桶算法是为了消除“突刺现象”，可以采用漏桶算法实现限流，漏桶算法这个名字就很形象，算法内部有一个容器，类似生活中用的漏斗，当请求进来时，相当于水倒入漏斗，然后从下端小口慢慢均速的流出。不管上面流量有多大，下面流出的速度始终不变。不管服务调用方多么地不稳定，通过漏斗算法进行限流，每10ms处理一次请求
因为处理的速度是未知的，可能进来很多请求，没来得及处理的请求就先放在桶里，既然是个桶，肯定有上限的，如果桶满了，那么新进来的请求就丢弃
##### 令牌桶算法
从某种意义来讲，令牌桶算法是漏桶算法的一种改进，桶算法能够限制请求调用的频率，而令牌桶算法能够在限制调用的平均速率的同时还允许有一定程度的突发调用。在令牌桶算法中，存在一个桶，用来存放固定数量的令牌。算法中存在一种机制，以一定的速率往桶中放令牌。每次请求调用需要先获取令牌，只有拿到令牌，才有机会执行，否则选择等待可用的令牌、或者直接拒绝。放令牌这个动作是持续不断进行的，如果桶中的令牌达上限，就丢弃令牌
所以存在这种情况，桶中一直有大量可用令牌，这时进来的请求就可以直接拿到令牌执行，比如设置qps为100，那么限流器初始化完成1s后，桶中就有100个令牌了，这时服务还没完全启动好，等启动完成对外提供服务时，该限流器可以抵挡瞬时的100个请求，所以，只有桶中没有令牌时，请求才会进行等待，最后相当于以一定的速率执行
#### Spring Cloud Gateway限流
限流作为网关基本功能，Spring Cloud Gateway官方提供了RequestRateLimiterGatewayFilterFactory，适用Redis和lua脚本实现了令牌桶方式，lua脚本在spring-cloud-gateway-core中的request_rate_limiter.lua文件中
使用方法，首先在pom文件中引入gateway的起步依赖和redis的reactive依赖
新建一个工程gateway-limiter，相关配置可见代码

源码：https://github.com/haijunY/demos-past/tree/master/spring-cloud-gateway/
